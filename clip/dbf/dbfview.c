/*
$Log: dbfview.c,v $
Revision 1.2  1999/10/26 19:19:09  axl
start cvs logging (./dbf)

*/


#include <stdio.h>
#include <unistd.h>
#include <string.h>
#include <stdlib.h>

#include "dbf.h"

static void
usage(int code)
{
	printf("usage: dbfview [-h] [-s] [-f] [-a] dbf_file\n");
	printf("\t-h\tthis help\n");
	printf("\t-s\tstructure only\n");
	printf("\t-f\tevery field on separate line\n");
	printf("\t-a\talternative database encoding (ru)\n");
	exit(code);
}

static DbfLocale alt_locale =
{
/*unsigned char _koi_cmptbl[] = */
	{
		0xc4, 0xb3, 0xda, 0xbf, 0xc0, 0xd9, 0xc3, 0xb4,
		0xc2, 0xc1, 0xc5, 0xdf, 0xdc, 0xdb, 0xdd, 0xde,
		0xb0, 0xb1, 0xb2, 0xf4, 0xfe, 0xf9, 0xfb, 0xf7,
		0xf3, 0xf2, 0xff, 0xf5, 0xf8, 0xfd, 0xfa, 0xf6,
		0xcd, 0xba, 0xd5, 0xf1, 0xd6, 0xc9, 0xb8, 0xb7,
		0xbb, 0xd4, 0xd3, 0xc8, 0xbe, 0xbd, 0xbc, 0xc6,
		0xc7, 0xcc, 0xb5, 0xf0, 0xb6, 0xb9, 0xd1, 0xd2,
		0xcb, 0xcf, 0xd0, 0xca, 0xd8, 0xd7, 0xce, 0xfc,
		0xee, 0xa0, 0xa1, 0xe6, 0xa4, 0xa5, 0xe4, 0xa3,
		0xe5, 0xa8, 0xa9, 0xaa, 0xab, 0xac, 0xad, 0xae,
		0xaf, 0xef, 0xe0, 0xe1, 0xe2, 0xe3, 0xa6, 0xa2,
		0xec, 0xeb, 0xa7, 0xe8, 0xed, 0xe9, 0xe7, 0xea,
		0x9e, 0x80, 0x81, 0x96, 0x84, 0x85, 0x94, 0x83,
		0x95, 0x88, 0x89, 0x8a, 0x8b, 0x8c, 0x8d, 0x8e,
		0x8f, 0x9f, 0x90, 0x91, 0x92, 0x93, 0x86, 0x82,
		0x9c, 0x9b, 0x87, 0x98, 0x9d, 0x99, 0x97, 0x9a
	},

/*unsigned char _koi_uptbl[] = */
	{
		0x80, 0x81, 0x82, 0x83, 0x84, 0x85, 0x86, 0x87,
		0x88, 0x89, 0x8a, 0x8b, 0x8c, 0x8d, 0x8e, 0x8f,
		0x90, 0x91, 0x92, 0x93, 0x94, 0x95, 0x96, 0x97,
		0x98, 0x99, 0x9a, 0x9b, 0x9c, 0x9d, 0x9e, 0x9f,
		0xa0, 0xa1, 0xa2, 0xa3, 0xa4, 0xa5, 0xa6, 0xa7,
		0xa8, 0xa9, 0xaa, 0xab, 0xac, 0xad, 0xae, 0xaf,
		0xb0, 0xb1, 0xb2, 0xb3, 0xb4, 0xb5, 0xb6, 0xb7,
		0xb8, 0xb9, 0xba, 0xbb, 0xbc, 0xbd, 0xbe, 0xbf,
		0xe0, 0xe1, 0xe2, 0xe3, 0xe4, 0xe5, 0xe6, 0xe7,
		0xe8, 0xe9, 0xea, 0xeb, 0xec, 0xed, 0xee, 0xef,
		0xf0, 0xf1, 0xf2, 0xf3, 0xf4, 0xf5, 0xf6, 0xf7,
		0xf8, 0xf9, 0xfa, 0xfb, 0xfc, 0xfd, 0xfe, 0xff,
		0xe0, 0xe1, 0xe2, 0xe3, 0xe4, 0xe5, 0xe6, 0xe7,
		0xe8, 0xe9, 0xea, 0xeb, 0xec, 0xed, 0xee, 0xef,
		0xf0, 0xf1, 0xf2, 0xf3, 0xf4, 0xf5, 0xf6, 0xf7,
		0xf8, 0xf9, 0xfa, 0xfb, 0xfc, 0xfd, 0xfe, 0xff,
	},

/*unsigned char _koi_lowtbl[] = */
	{
		0x80, 0x81, 0x82, 0x83, 0x84, 0x85, 0x86, 0x87,
		0x88, 0x89, 0x8a, 0x8b, 0x8c, 0x8d, 0x8e, 0x8f,
		0x90, 0x91, 0x92, 0x93, 0x94, 0x95, 0x96, 0x97,
		0x98, 0x99, 0x9a, 0x9b, 0x9c, 0x9d, 0x9e, 0x9f,
		0xa0, 0xa1, 0xa2, 0xa3, 0xa4, 0xa5, 0xa6, 0xa7,
		0xa8, 0xa9, 0xaa, 0xab, 0xac, 0xad, 0xae, 0xaf,
		0xb0, 0xb1, 0xb2, 0xb3, 0xb4, 0xb5, 0xb6, 0xb7,
		0xb8, 0xb9, 0xba, 0xbb, 0xbc, 0xbd, 0xbe, 0xbf,
		0xc0, 0xc1, 0xc2, 0xc3, 0xc4, 0xc5, 0xc6, 0xc7,
		0xc8, 0xc9, 0xca, 0xcb, 0xcc, 0xcd, 0xce, 0xcf,
		0xd0, 0xd1, 0xd2, 0xd3, 0xd4, 0xd5, 0xd6, 0xd7,
		0xd8, 0xd9, 0xda, 0xdb, 0xdc, 0xdd, 0xde, 0xdf,
		0xc0, 0xc1, 0xc2, 0xc3, 0xc4, 0xc5, 0xc6, 0xc7,
		0xc8, 0xc9, 0xca, 0xcb, 0xcc, 0xcd, 0xce, 0xcf,
		0xd0, 0xd1, 0xd2, 0xd3, 0xd4, 0xd5, 0xd6, 0xd7,
		0xd8, 0xd9, 0xda, 0xdb, 0xdc, 0xdd, 0xde, 0xdf,
	},
/*unsigned char alt2koi[] = */
	{
		0xe1, 0xe2, 0xf7, 0xe7, 0xe4, 0xe5, 0xf6, 0xfa,
		0xe9, 0xea, 0xeb, 0xec, 0xed, 0xee, 0xef, 0xf0,
		0xf2, 0xf3, 0xf4, 0xf5, 0xe6, 0xe8, 0xe3, 0xfe,
		0xfb, 0xfd, 0xff, 0xf9, 0xf8, 0xfc, 0xe0, 0xf1,
		0xc1, 0xc2, 0xd7, 0xc7, 0xc4, 0xc5, 0xd6, 0xda,
		0xc9, 0xca, 0xcb, 0xcc, 0xcd, 0xce, 0xcf, 0xd0,
		0x90, 0x91, 0x92, 0x81, 0x87, 0xb2, 0xb4, 0xa7,
		0xa6, 0xb5, 0xa1, 0xa8, 0xae, 0xad, 0xac, 0x83,
		0x84, 0x89, 0x88, 0x86, 0x80, 0x8a, 0xaf, 0xb0,
		0xab, 0xa5, 0xbb, 0xb8, 0xb1, 0xa0, 0xbe, 0xb9,
		0xba, 0xb6, 0xb7, 0xaa, 0xa9, 0xa2, 0xa4, 0xbd,
		0xbc, 0x85, 0x82, 0x8d, 0x8c, 0x8e, 0x8f, 0x8b,
		0xd2, 0xd3, 0xd4, 0xd5, 0xc6, 0xc8, 0xc3, 0xde,
		0xdb, 0xdd, 0xdf, 0xd9, 0xd8, 0xdc, 0xc0, 0xd1,
		0xb3, 0xa3, 0x99, 0x98, 0x93, 0x9b, 0x9f, 0x97,
		0x9c, 0x95, 0x9e, 0x96, 0xbf, 0x9d, 0x94, 0x9a
	},
/* unsigned char koi2alt[] = */
	{
		0xc4, 0xb3, 0xda, 0xbf, 0xc0, 0xd9, 0xc3, 0xb4,
		0xc2, 0xc1, 0xc5, 0xdf, 0xdc, 0xdb, 0xdd, 0xde,
		0xb0, 0xb1, 0xb2, 0xf4, 0xfe, 0xf9, 0xfb, 0xf7,
		0xf3, 0xf2, 0xff, 0xf5, 0xf8, 0xfd, 0xfa, 0xf6,
		0xcd, 0xba, 0xd5, 0xf1, 0xd6, 0xc9, 0xb8, 0xb7,
		0xbb, 0xd4, 0xd3, 0xc8, 0xbe, 0xbd, 0xbc, 0xc6,
		0xc7, 0xcc, 0xb5, 0xf0, 0xb6, 0xb9, 0xd1, 0xd2,
		0xcb, 0xcf, 0xd0, 0xca, 0xd8, 0xd7, 0xce, 0xfc,
		0xee, 0xa0, 0xa1, 0xe6, 0xa4, 0xa5, 0xe4, 0xa3,
		0xe5, 0xa8, 0xa9, 0xaa, 0xab, 0xac, 0xad, 0xae,
		0xaf, 0xef, 0xe0, 0xe1, 0xe2, 0xe3, 0xa6, 0xa2,
		0xec, 0xeb, 0xa7, 0xe8, 0xed, 0xe9, 0xe7, 0xea,
		0x9e, 0x80, 0x81, 0x96, 0x84, 0x85, 0x94, 0x83,
		0x95, 0x88, 0x89, 0x8a, 0x8b, 0x8c, 0x8d, 0x8e,
		0x8f, 0x9f, 0x90, 0x91, 0x92, 0x93, 0x86, 0x82,
		0x9c, 0x9b, 0x87, 0x98, 0x9d, 0x99, 0x97, 0x9a
	}
};

int
main(int argc, char **argv)
{
	int i, r = 0;
	struct DbfFile *fp;
	char errbuf[256];
	DbfField **fields;
	int nfield;
	char *name;
	int struct_flag = 0;
	int field_flag = 0;
	long reccount;
	DbfLocale *dbf_locale = 0;

	for (++argv, --argc; argc > 0; ++argv, --argc)
	{
		char *ap = argv[0];

		if (ap[0] != '-')
			break;
		switch (ap[1])
		{
		case 'h':
			usage(0);
		default:
			printf("invalid option '%s'\n", ap);
			++r;
			break;
		case 's':
			struct_flag = 1;
			break;
		case 'f':
			field_flag = 1;
			break;
		case 'a':
			dbf_locale = &alt_locale;
			break;
		}
	}

	if (r || argc < 1)
		usage(1);

	name = argv[0];

	fp = open_DbfFile(name, DBF_NTX | DBF_DBT, 0, 0, dbf_calc, dbf_locale, errbuf, sizeof(errbuf));

	if (!fp)
	{
		printf("cannot open dbf file '%s': %s\n", name, errbuf);
		return 1;
	}

	recCount_DbfFile(fp, &reccount);
	nfield = nfield_DbfFile(fp);
	fields = (DbfField **) malloc(sizeof(DbfField *) * nfield);

	for (i = 0; i < nfield; ++i)
		fields[i] = field_DbfFile(fp, i);

	if (struct_flag)
	{
		printf("dbf base '%s': %d fields, %ld records\n", name_DbfFile(fp), nfield, reccount);
		for (i = 0; i < nfield; ++i)
		{
			DbfField *fld = fields[i];

			printf("%d:\t%-11s\t%c\t%d\t%d\n", i, fld->name, fld->type, fld->len, fld->dec);
		}
		exit(0);
	}

	printf("\n");
	for (i = 1, r = goTop_DbfFile(fp); !r; r = skip_DbfFile(fp, 1), ++i)
	{
		int eof;
		int j;
		long recno;
		DbfData item;

		if ((r = eof_DbfFile(fp, &eof)))
			goto err;
		if (eof)
			break;
		if ((r = recNo_DbfFile(fp, &recno)))
			goto err;
		printf("no: %d pos: %ld%s", i, recno, field_flag ? "" : ": ");
		for (j = 0; j < nfield; ++j)
		{
			if (getVal_DbfFile(fp, j, &item))
				goto err;
			if (field_flag)
				printf("\n%-11s: ", fields[j]->name);
			else
				printf("| ");
			switch (item.type)
			{
			case 'M':
			case 'C':
				printf("'%-.*s'", item.u.c.len, item.u.c.str);
				break;
			case 'L':
				printf("%c", item.u.l ? 'T' : 'F');
				break;
			case 'N':
				printf("%-*.*f", item.len, item.dec, item.u.n);
				break;
			case 'D':
				{
					int dd, mm, yy, ww;

					dbf_cdate(item.u.d, &dd, &mm, &yy, &ww);
					printf("%02d/%02d/%04d", dd, mm, yy);
				}
				break;
			default:
				printf("UNDEF");
				break;
			}
		}
		printf("\n");
	}

	if (r)
		goto err;

	goto end;
      err:{
		long pos;

		getError_DbfFile(fp, errbuf, sizeof(errbuf));
		recNo_DbfFile(fp, &pos);
		printf("pos: %ld; error : %s\n", pos, errbuf);
		goto end;
	}

      end:
	close_DbfFile(fp);
	return r;
}
